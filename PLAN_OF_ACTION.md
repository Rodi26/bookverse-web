# BookVerse Web — Plan of Action

## Goals and constraints
- **Simplicity**: tiny code surface, minimal dependencies, fast build.
- **Demo-first**: showcase AppTrust and CI/CD artifacts/versioning; UI is clean and minimal.
- **Runtime-configurable**: all service URLs and flags via `config.js` (injected at container start).
- **Usability & maintainability**: easy to debug, clear structure, well-documented.

## Current baseline to preserve
- Build with Vite; serve via nginx (`nginx.conf`).
- Runtime `config.js` generated by `entrypoint.sh` from env vars.
- Vanilla JS (no heavy framework) to reduce complexity.

## UX scope (single-page with 4 views)
- **Home (`#/`)**: environment banner, service status badges, “Recs for you”, quick search.
- **Catalog (`#/catalog`)**: search + filter; paginated list; add-to-cart.
- **Book details (`#/book/:id`)**: metadata + recommendations; add-to-cart; related by tags/authors.
- **Cart/Checkout (`#/cart`)**: cart summary; create order; show order ID and receipt link.

## Core logic & algorithms
### Lightweight hash router
- Routes: `#/`, `#/catalog`, `#/book/:id`, `#/cart`.
- On `hashchange`, render view function; no global framework state.

### Resilient service client with caching, retries, and circuit breaker
- Base URLs: from `window.__BOOKVERSE_CONFIG__` keys: `inventoryBaseUrl`, `recommendationsBaseUrl`, `checkoutBaseUrl`.
- Request features:
  - Timeout (e.g., 2500 ms) and up to 2 retries with jittered backoff.
  - In-flight request deduplication by request key.
  - Per-service circuit breaker (open after N consecutive failures, half-open after cool-down).
  - `traceparent` propagation and `X-Request-Id` per request.
  - GET response caching: memory + `localStorage` with TTL.

```javascript
// pseudocode
async function resilientFetch(service, path, opts) {
  if (circuitOpen(service)) return cachedOrFallback(service, path);
  const key = requestKey(service, path, opts);
  if (inFlight.has(key)) return inFlight.get(key);
  const attempt = () => fetchWithTimeout(urlFor(service, path), withHeaders(opts));
  const p = retryWithJitter(attempt, { retries: 2, baseMs: 200 });
  inFlight.set(key, p);
  try {
    const res = await p; recordSuccess(service); cacheResponse(key, res); return res;
  } catch (e) {
    recordFailure(service); if (shouldOpenBreaker(service)) openBreaker(service);
    return cachedOrFallback(service, path);
  } finally { inFlight.delete(key); }
}
```

### Search and autocomplete
- Debounce input by ~300 ms before querying inventory `/books?query=...`.
- Fallback when API unavailable: simple token overlap scoring over the last fetched page.

```javascript
// score = sum(commonTokens) / Math.sqrt(qTokens.length * titleTokens.length)
```

### Recommendations blending (robust to outages)
- Prefer `recommendations` service (top-N by session/user); if down, compute heuristic recs from inventory:
  - Token-based similarity on `title`, `authors`, `tags`.
  - Boost by category match; small popularity boost (if available).
  - Final score: `0.6 * jaccard(tokens) + 0.3 * categoryMatch + 0.1 * popularityNorm`.
- Blend remote + heuristic results; de-duplicate by `bookId`.

### Pagination and prefetch
- Use cursor if provided; else `limit/offset`.
- Prefetch next page using `IntersectionObserver` when scroller nears bottom.

### Cart and checkout
- Cart persisted in `localStorage` keyed by `bookId` with quantity.
- Idempotent checkout: compute `X-Idempotency-Key` from sorted cart items + total.
- Handle `409 Duplicate`/retries by surfacing stable order confirmation.

### Feature flags & demo toggles
- From runtime config: `enableDebugPanel`, `forceRecsDown`, `defaultPageSize`, etc.
- Keyboard shortcut to toggle failure simulation for demo.

### Trust & provenance panel (AppTrust UX)
- “Release Info” modal shows:
  - App version, commit, image digest(s).
  - Links to provenance, signatures, and CI build info (AppTrust will surface SBOMs separately).
  - Per-service trust status by reading `/.well-known/apptrust/evidence.json` (emitted by CI) or calling `/trust/health` if backends support.
- Visual badges: Signed, Provenance, Verified.

### Observability & debugging
- Sticky debug panel: service status, breaker state, recent requests, last errors, config snapshot.
- “Copy debug bundle” button dumps recent logs/state as JSON for support.

## Runtime config & validation
- Keep `entrypoint.sh` injecting `config.js` from env.
- Add `config.schema.json`; validate on load and show banner if invalid with missing keys.
- Config keys: `env`, base URLs, feature flags, demo toggles, pagination size.

## Minimal code organization
```
src/
  main.js
  router.js
  ui/
    home.js
    catalog.js
    book.js
    cart.js
  services/
    http.js
    inventory.js
    recommendations.js
    checkout.js
  store/
    cart.js
  trust/
    panel.js
    manifest-loader.js
  util/
    debounce.js
    score.js
    circuitBreaker.js
```

## CI/CD plan (aligned with inventory/recommendations)
### Build and verify
- Node LTS (20.x); lint and small unit tests for `util/*`.
- Build assets: production and “debug” (non-minified + inline sourcemaps).

### Release artifacts
- **Docker images (2)**
  - `bookverse-web:prod` — nginx + minified assets (deploy to prod).
  - `bookverse-web:debug` — nginx + non-minified + sourcemaps (QA/debug).
- **Static bundles**
  - `dist.tar.gz` and `sourcemaps.tar.gz` for alternative deploy and debugging.
- **Config schema**
  - `config.schema.json` for validating runtime config.
- **Trust manifest**
  - `/.well-known/apptrust/evidence.json` with pointers to evidence generated in CI (AppTrust surfaces SBOMs automatically).

### Pipeline outline (GitHub Actions style)
1. Checkout, setup Node.
2. Install deps, lint, run unit tests.
3. Build `prod` and `debug` assets.
4. Build and push Docker images via JFrog CLI (`prod`, `debug`) with build-info.
5. Package `dist.tar.gz`, `sourcemaps.tar.gz`; upload as build artifacts.
6. Create or update application version referencing the build-info (like inventory).
7. Attach coverage and SAST evidence to images (same pattern as recommendations).
8. Publish trust manifest and update summary.
9. Promotion workflow: on approval, promote images and update GitOps values.

## Environments & GitOps
- Use `bookverse-helm` and `bookverse-demo-assets` for Dev → QA → Staging → Prod.
- Values gate: choose `debug` vs `prod` image; toggle debug panel; inject per-env URLs.
- Health gates: promote only if trust checks pass (policy-driven via AppTrust).

## Documentation deliverables
- `README.md`, `ARCHITECTURE.md`, `OPERATIONS.md`, `TRUST.md`, `CI_CD.md`.

## Why this fits the demo
- Minimal code yet robust for demoing resilience and trust.
- CI/CD mirrors inventory/recommendations, avoiding SBOM duplication while keeping diverse artifacts.
- Trust panel makes AppTrust tangible without complicating backends.

---
Owner: Web team • Tech: Vite + nginx • Runtime config: `config.js` • Focus: AppTrust + CI/CD
